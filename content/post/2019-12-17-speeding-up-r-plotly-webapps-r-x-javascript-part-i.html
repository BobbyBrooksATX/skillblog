---
title: Speeding up R Plotly web apps - R x Javascript part I
author: Timothy Lin
date: '2019-12-17'
slug: speeding-up-r-plotly-webapps-r-x-javascript-part-i
categories: []
tags: ['notes', 'javascript', 'r', 'visualisation', "Dashboard"]
subtitle: ''
---



<p>Back to blogging! Sorry for the long hiatus, had some personal projects which kept me really occupied over the past few months. Hope to share about them one of these days and potentially even explore open sourcing parts of them but the idea of this post is to transfer some of my learnings over the past year to an issue in R that always irritated me - slow loading webapps. Over the past year, I picked up quite a bit of javascript skills that I think it is fair to say makes me a full stack data scientist.</p>
<p><strong>What is javascript?</strong> Javascript is the programming language that powers the web. That means all interactive web based visualizations such as the D3 framework, plotly, highcharts and even R shiny are all based in javascript.</p>
<p><strong>Why javascript?</strong> I get this question too frequently from other data science candidates I interview, but in short I feel that there is a big gulf between analysis and actually producing useful output. Sure, shiny, tableau and other BI tools has made data visualization much more accessible but I think there are many other small gaps that are not served by existing tools. Knowing javascript has given me the ability to fully control the development of any data science project from conception to execution :)</p>
<div id="speeding-up-r-plotly-web-apps" class="section level2">
<h2>Speeding up R plotly web apps</h2>
<p>Now let‚Äôs take that javascript knowledge back to R and apply some tricks to speed up our R visualization dashboard built on plotly and flexdashboard. I like plotly as a visualization library - it‚Äôs interactive and beautiful. To make it even better, you can easily convert a static ggplot image to an interactive visualization using the <code>ggplotly()</code> function. The only downside is that it seems to take quite long to load. Let‚Äôs investigate and see what‚Äôs the issue. I will use my <a href="https://www.timlrx.com/dashboard/sg-dashboard">sg-dashboard</a> as a guide.</p>
<p>Side story, I was wondering why there were so few viewers for my posts which featured plotly interactive graphs compared to the rest of my blog. After some digging, I realise that it takes quite a bit longer to load than most other pages which makes it both user and search engine unfriendly. I considered switching to other smaller packages but in the end found some tricks to reduce the bundle size.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> I am sure the techniques featured would be useful for other htmlwidgets with relatively large javascript bundles as well.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<p>When it comes to debugging web applications, chrome devtools (F12) is our best friend. Here‚Äôs what my local dashboard html file looks like:</p>
<p><img src="/img/r_js/part1_devtools1.PNG" /></p>
<p>We can see that the html file is 3.5MB big! It takes only 200ms to load as it is from my local computer but having to move a 3.5MB file across the internet might take a few seconds. Why is the file so big? This is explained by the <code>self_contained</code> argument in flex dashboard:</p>
<blockquote>
<p>Produce a standalone HTML file with no external dependencies, using data:
URIs to incorporate the contents of linked scripts, stylesheets, images, and
videos.</p>
</blockquote>
<p>A lot of the output in R, such as htmlwidgets, are built primarly for internal sharing purposes. Hence, they package all the html, css, js dependencies in a single file which makes sharing the widget or dashboard relatively easy email. However, this obscures the reason for the file bloat so let‚Äôs turn off self_contained mode. Another small optimization we can do is to disable mathjax since we are only using simple graphs with no math symbols. Here‚Äôs how our flexdashboard config looks like:</p>
<pre class="r"><code>title: &quot;SG-Dashboard&quot;
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    mathjax: NULL
    self_contained: FALSE</code></pre>
<p>We can knit the file again. This time it produces a folder with the seperate javascript dependencies. You should see the bootstrap theme, jquery and of course plotly which takes up 3.1MB! The number of graphs you plot or the type of graphs you use does not affect the bundle size - the whole plotly package is loaded. So this means that even though we are only using bar and line charts, the scripts for drawing maps, 3D graphs, heatmaps etc. are all being loaded.</p>
<p>Thankfully, that‚Äôs a way around this that is already built into R plotly. Since v1.39.0, partial bundles are available<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. To use this, we just need to pass our plotly object to the partial_bundle function:</p>
<pre class="r"><code>ggplotly(graph) %&gt;%
  partial_bundle() </code></pre>
<p>This gives us a 70% reduction in loading time since the minified size of the basic bundle is about 850kB. The only other thing to note is that you have to apply this to all your plotly graphs.<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<p>If you check out <a href="https://github.com/plotly/plotly.js/tree/master/dist">plotly‚Äôs github page</a>, you might have noticed that the basic bundle is 277kB minified + gzip. How are we able to get that further size reduction? That‚Äôs the job of our web hosting service (Netlify in my case), who would serve the file in a compressed form. Let‚Äôs take a look at chrome dev tools once again:</p>
<p><img src="/img/r_js/part1_devtools2.PNG" /></p>
<p>The bar at the bottom shows that now 418kB of content was pushed to us. That‚Äôs the minified size. 1.3MB refers to the unminified size.</p>
<p>That‚Äôs it, we are done and our dashboard is now around 3 times faster üëèüëèüëè</p>
</div>
<div id="bonus" class="section level2">
<h2>Bonus</h2>
<p>Another possibility is to use a CDN to serve the javascript assets. Perhaps we do not have a good hosting service<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> or we just want to leverage on a popular CDN to cache common web packages that are frequently used by the users.</p>
<p>Here‚Äôs how to do it. It‚Äôs quite a hack but it‚Äôs an interesting exploration of how javascript dependencies are stored in an R object. Let‚Äôs explore the insides of a plotly object.</p>
<pre class="r"><code>library(ggplot2)
library(plotly)

p &lt;- qplot(mpg, wt, data = mtcars) %&gt;% 
  ggplotly() %&gt;% 
  partial_bundle()
  
ls(p)</code></pre>
<pre><code>## [1] &quot;dependencies&quot;  &quot;elementId&quot;     &quot;height&quot;        &quot;jsHooks&quot;      
## [5] &quot;preRenderHook&quot; &quot;sizingPolicy&quot;  &quot;width&quot;         &quot;x&quot;</code></pre>
<p>We see an interesting ‚Äòdependencies‚Äô object as part of plotly. Let‚Äôs take a look at one of the dependencies:</p>
<pre class="r"><code>p$dependencies[[5]]</code></pre>
<pre><code>## List of 12
##  $ name          : chr &quot;plotly-basic&quot;
##  $ version       : chr &quot;1.49.4&quot;
##  $ src           :List of 2
##   ..$ href: chr &quot;https://cdn.plot.ly&quot;
##   ..$ file: chr &quot;C:/Users/timot/AppData/Local/Temp/RtmpOQRktA&quot;
##  $ meta          : NULL
##  $ script        : chr &quot;plotly-basic-1.49.4.min.js&quot;
##  $ stylesheet    : NULL
##  $ head          : NULL
##  $ attachment    : NULL
##  $ all_files     : logi FALSE
##  $ local         : logi TRUE
##  $ minified      : logi TRUE
##  $ partial_bundle: chr &quot;auto&quot;
##  - attr(*, &quot;class&quot;)= chr &quot;html_dependency&quot;</code></pre>
<p>We found the plotly dependency. It references both a web source as well as local file source but unfortunately will crash with a ‚Äúpath for html_dependency not provided‚Äù error when we try to knit it. This is an irritating bug documented here: <a href="https://github.com/rstudio/rmarkdown/issues/794" class="uri">https://github.com/rstudio/rmarkdown/issues/794</a>. We need to fix it manually and pass a CDN reference to it. Here‚Äôs a script that does that:<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a></p>
<pre class="r"><code>plotly_mod_dep = function(p){
  deps &lt;- p$dependencies
  deps_urls &lt;- purrr::map(
    deps,
    ~if(.x$name == &quot;plotly-basic&quot;) {
      .x$src = list(file=getwd())
      .x$script = &quot;plotly-redirect-cdn-1.39.2.js&quot;
      .x
    } else {
      .x
    }
  )
  p$dependencies &lt;- deps_urls
  p
}</code></pre>
<p>The <code>plotly-redirect-cdn-1.39.2.js</code> file is a simple one-liner:</p>
<pre class="js"><code>document.write(&#39;&lt;script src=&quot;https://cdn.plot.ly/plotly-basic-1.39.2.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;&#39;);</code></pre>
<script type="text/javascript">
document.write('<script src="https://cdn.plot.ly/plotly-basic-1.39.2.min.js" type="text/javascript"></script>
‚Äô);
</script>
<p>We can modify our function to the following:</p>
<pre class="r"><code>p &lt;- qplot(mpg, wt, data = mtcars) %&gt;% 
  ggplotly %&gt;% 
  partial_bundle(local = FALSE) %&gt;%
  plotly_mod_dep()</code></pre>
<p>And now our content is delivered by plotly‚Äôs CDN!</p>
<p>That‚Äôs it for this blog post. Hope you find some useful tricks to speed up your R plotly load times! Check back soon for the next installment of R X Javascript tricks and tips.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I guess that shows R‚Äôs main focus as an internal data science tool rather than to deliver analytics through the web.<a href="#fnref1" class="footnote-back">‚Ü©</a></p></li>
<li id="fn2"><p>See the bonus section on using a CDN<a href="#fnref2" class="footnote-back">‚Ü©</a></p></li>
<li id="fn3"><p><a href="https://github.com/plotly/plotly.js/tree/master/dist" class="uri">https://github.com/plotly/plotly.js/tree/master/dist</a><a href="#fnref3" class="footnote-back">‚Ü©</a></p></li>
<li id="fn4"><p>Also as mentioned in the documentation: ‚ÄúWARNING: use this function with caution when rendering multiple plotly graphs on a single website. That‚Äôs because, if multiple plotly.js bundles are used, the most recent bundle will override the other bundles.‚Äù<a href="#fnref4" class="footnote-back">‚Ü©</a></p></li>
<li id="fn5"><p>Check out netlify - it‚Äôs great!<a href="#fnref5" class="footnote-back">‚Ü©</a></p></li>
<li id="fn6"><p>This was inspired by <a href="https://github.com/ramnathv/htmlwidgets/issues/79" class="uri">https://github.com/ramnathv/htmlwidgets/issues/79</a><a href="#fnref6" class="footnote-back">‚Ü©</a></p></li>
</ol>
</div>
